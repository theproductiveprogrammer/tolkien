<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tolkien Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
* { margin: 0; padding: 0; font-size: 1em; font-weight: normal; }
    </style>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

</head>
<body>
    <div id=col>
        <div id=acts>
            <a id=new href=/ target=_blank>+</a>
            <a id=prvbtn onclick=toggle_prv()></a>
        </div>
        <h1 id=title>Tolkien</h1>
        <div id=instructions>
            <img id=icon alt="icon" src="tolkien.clr.png">
            <div id=link>
                Writing is hard. All serious writers know that.
                <p>
                Tolkien is an editor that helps you let go and get those
                creative juices flowing. It's weird and messy and you
                will find it clumsy to use at first. It's almost like
                <a href=https://github.com/theproductiveprogrammer/tolkien#readme>
                    an annoying little monkey stamping all over your code
                </a>
                but it can make you fall in love
                with writing all over again. More importantly - it makes
                your readers fall in love with you again.
                <p>
                Tolkien makes writing fun.
                <a href=https://github.com/theproductiveprogrammer/tolkien#readme>
                    Learn How (includes a short video)
                </a>
                or Just Start Writing!
                <p>
                Enjoy.
            </div>
            <ol id=steps>
                <li>Set a Goal</li>
                <li>Bring your reader to mind</li>
                <li>Write!</li>
            </ol>
        </div>
        <textarea id=ta placeholder='write here'></textarea>
        <div id=prv></div>
        <button id=btn>Monkey Around (Shift+Enter)</button>
        <button id=clean>Clean Up!</button>
        <div id=footer>
            <a href=https://github.com/theproductiveprogrammer/tolkien#readme>
                Project Page
            </a>
        </div>
    </div>
<style>
#col,#title, #instructions {
    margin: 0 auto;
    width: 400px;
}
#acts {
    position: relative;
    font-size: 14px;
    color: #ccc;
}
#new {
    text-decoration: overline;
}
#new:hover,#prvbtn:hover {
    color: black;
}
#prvbtn {
    position: absolute;
    right: 0;
    text-decoration: overline;
    cursor: pointer;
}
#icon {
    display: block;
    margin: 0 auto;
    width: 96px;
}
#link {
    width: 400px;
    margin-top: 1em;
}
#link p {
    padding-top: 8px;
}
#link a {
    text-decoration: none;
}
#steps {
    display: block;
    margin: 2em auto;
    width: 200px;
    list-style-position: inside;
    font-size: 14px;
}
#instructions {
    height: 100%;
    opacity: 1;
    font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
    line-height: 1.2em;
    font-size: 18px;
}
#instructions.writing {
    display: none;
    overflow: hidden;
    height: 0;
    opacity: 0;
    transition: height 50ms;
}
#btn {
    display: none;
    margin: 0 auto;
    padding: 8px;
    width: 400px;
    border-radius: 4px;
}
#clean {
    display: none;
    margin: 0 auto;
    padding: 8px;
    width: 200px;
    border-radius: 4px;
}
#btn.writing, #clean.writing {
    display: block;
}
#btn.prv, #clean.prv {
    display: none;
}
#title {
    margin-top: 1em;
    margin-bottom: 0.25em;
    text-align: center;
    font-size: 48px;
    color: #333;
}
#title.writing {
    margin-top: 0;
    margin-bottom: 1em;
    animation: 10s pulse infinite alternate;
}
#title.prv {
    display: none;
}
#ta {
    width: 400px;
    height: 400px;
    border: none;
    padding: 12px;
    font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
    font-weight: 400;
    font-size: 20px;
}
#prv {
    margin: 2em 0;
    width: 400px;
    font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
    font-weight: 400;
    font-size: 20px;
}
#ta:focus {
    border: none;
    box-shadow: 0;
    outline: none !important;
}
#ta.prv {
    display: none;
}
#prv {
    display: none;
}
.prvtitle {
    font-weight: bold;
    font-size: 24px;
}
.prvmonkey {
    font-style: italic;
    color: #ccc;
    font-size: 0.8em;
}
.prvtxt {
    padding-top: 0.8em;
}
#prv.prv {
    display: block;
}

#footer {
    background: #ccc;
    padding: 24px;
    margin: 24px auto;
    width: 352px;
    text-align: center;
    font-size: 12px;
    font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
}
#footer a {
    color: white;
    font-weight: 300;
}
#footer:hover {
    background: #333;
}

@keyframes pulse {
    0% { opacity: 0; }
    50% { opacity: 0.8; }
    100% { opacity: 0; }
}

</style>

    <script>
        // src: https://hackernoon.com/copying-text-to-clipboard-with-javascript-df4d4988697f
const copyToClipboard = str => {
  const el = document.createElement('textarea');  // Create a <textarea> element
  el.value = str;                                 // Set its value to the string that you want copied
  el.setAttribute('readonly', '');                // Make it readonly to be tamper-proof
  el.style.position = 'absolute';
  el.style.left = '-9999px';                      // Move outside the screen to make it invisible
  document.body.appendChild(el);                  // Append the <textarea> element to the HTML document
  const selected =
    document.getSelection().rangeCount > 0        // Check if there is any content selected previously
      ? document.getSelection().getRangeAt(0)     // Store selection if found
      : false;                                    // Mark as false to know no selection existed before
  el.select();                                    // Select the <textarea> content
  document.execCommand('copy');                   // Copy - only works as a result of a user action (e.g. click events)
  document.body.removeChild(el);                  // Remove the <textarea> element
  if (selected) {                                 // If a selection existed before copying
    document.getSelection().removeAllRanges();    // Unselect everything on the HTML document
    document.getSelection().addRange(selected);   // Restore the original selection
  }
};
    </script>

    <script>
        let title = document.getElementById('title')
        let instructions = document.getElementById('instructions')
        let btn = document.getElementById('btn')
        let clean = document.getElementById('clean')
        let ta = document.getElementById('ta')
        let prv = document.getElementById('prv')

        ta.focus()

        let started = false
        let prvon = false
        function toggle_prv() {
            if(!started) return
            if(prvon) prvoff_1()
            else prvon_1()

            function prvon_1() {
                prvon=true

                let txt = ta.value ? ta.value : ""
                let lines = txt.split('\n')

                prv.innerHTML = ""
                let copytxt = []
                for(let i = 0;i < lines.length;i++) {
                    let l = lines[i]
                    add_line_1(l, i ? 'prvtxt' : 'prvtitle')
                    if(!is_monkey_1(l)) copytxt.push(l)
                }
                copyToClipboard(copytxt.join('\n'))

                prvbtn.innerText = "write"
                prv.className = 'prv'
                ta.className = 'prv'
                title.className = 'prv'
                btn.className = 'prv'
                clean.className = 'prv'
            }

            function is_monkey_1(l) {
                return l && l.startsWith(">>      ")
            }

            function add_line_1(line, class_) {
                if(is_monkey_1(line)) class_ = 'prvmonkey'
                let e = document.createElement('div')
                e.className = class_
                e.innerText = line
                prv.appendChild(e)
            }

            function prvoff_1() {
                prvon = false

                prv.className = ''
                ta.className = ''
                prvbtn.innerText = "c+v"
                title.className = 'writing'
                btn.className = 'writing'
                clean.className = 'writing'
            }
        }

        function withData(url_) {
            ta.focus()
            let o = {
                txt: ta.value,
                cursor: ta.selectionStart,
            }
            send2Server(url_, o, (err, upd) => {
                if(err) {
                    alert('Error!')
                    console.error(err)
                } else {
                    ta.value = upd.txt
                    ta.selectionStart = upd.cursor
                    ta.selectionEnd = upd.cursor
                    ta.blur()
                    ta.focus()
                    setCleaningUp()
                }
            })
        }

        function monkey() {
            withData('/monkey')
        }

        function cleanMonkey() {
            withData('/clean')
        }

        function send2Server(url_, data, cb) {
            let xhr = new XMLHttpRequest()
            xhr.onreadystatechange = function() {
                if(xhr.readyState !== XMLHttpRequest.DONE) return
                if(xhr.status !== 200) cb(xhr)
                else {
                    try {
                        let r = JSON.parse(xhr.responseText)
                        cb(null, r)
                    } catch(e) {
                        cb(e)
                    }
                }
            }
            xhr.open('POST', url_)
            xhr.setRequestHeader("Content-Type", "application/json")
            xhr.send(JSON.stringify(data))
        }


        function startedWriting() {
            started = true
            prvbtn.innerText = "c+v"
            title.innerText = "Write"
            title.className = "writing"
            btn.className = "writing"
            clean.className = "writing"
            instructions.className = "writing"
        }

        let cleaningup = 0
        let prev_val
        const MONKEY_MARKER = '>>      '
        const MONKEY_MARKER_RX = /\n>>      /g
        function setCleaningUp() {
            let pv = prev_val
            let v = ta.value
            prev_val = v
            if(!pv) return
            if(pv.length - v.length < MONKEY_MARKER.length) return
            let pnum_lines = pv.split(MONKEY_MARKER_RX).length
            let num_lines = v.split(MONKEY_MARKER_RX).length
            if(num_lines < pnum_lines) {
                if(!cleaningup) cleaningup = 1
                else cleaningup++
                if(cleaningup > 4) cleaningup = 4
            }
        }


        ta.oninput = () => {
            if(!started) startedWriting()
            setCleaningUp()
        }

        ta.onkeyup = (e) => {
            if(e.keyCode == 13) {
                if(e.shiftKey) monkey()
                else {
                    let txt = ta.value ? ta.value : ""
                    let cursor = ta.selectionEnd ? ta.selectionEnd : ta.selectionStart
                    if(txt[cursor-1] == '\n'
                        && txt[cursor-2] == '\n'
                        && txt[cursor-3] != '\n') {
                        if(cleaningup > 0) cleaningup--
                        else monkey()
                    }
                }
            }
        }

        btn.onclick = monkey
        clean.onclick = cleanMonkey

    </script>
</body>
</html>
