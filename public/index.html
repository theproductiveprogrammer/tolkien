<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tolkien Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
* { margin: 0; padding: 0; font-size: 1em; font-weight: normal; }
    </style>
</head>
<body>
    <div id=col>
        <h1 id=title>Tolkien</h1>
        <div id=instructions>
            <img id=icon alt="icon" src="tolkien.clr.png">
            <div id=link>
                Tolkien is a simple editor whose singular focus is to
                unleash your inner Creative Writer. Almost everyone
                starts off finding it strange to use but those who make
                it past the initial hump find it surprisingly powerful
                and enjoyable to use.
                <p>
                If you need to make your words sing and have all your
                readers happily follow you and your ideas, then you need
                Tolkien.
                <p>
                To find out more on how it works
                <a href=https://github.com/theproductiveprogrammer/tolkien#readme>
                    click here.
                </a>

                Otherwise, just start writing.
            </div>
            <ol id=steps>
                <li>Set a Goal</li>
                <li>Bring your reader to mind</li>
                <li>Write!</li>
            </ol>
        </div>
        <textarea id=ta></textarea>
        <button id=btn>Monkey Around (Shift+Enter)</button>
        <button id=clean>Clean Up!</button>
        <div id=footer>
            <a href=https://github.com/theproductiveprogrammer/tolkien#readme>
                Project Page
            </a>
        </div>
    </div>
<style>
#col,#title, #instructions {
    margin: 0 auto;
    width: 400px;
}
#icon {
    display: block;
    margin: 0 auto;
    width: 96px;
}
#link {
    width: 400px;
    margin-top: 1em;
}
#link p {
    padding-top: 8px;
}
#link a {
    text-decoration: none;
}
#steps {
    display: block;
    margin: 2em auto;
    width: 200px;
    list-style-position: inside;
    font-size: 14px;
}
#instructions {
    height: 100%;
    opacity: 1;
    font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
    line-height: 1.2em;
    font-size: 18px;
}
#instructions.writing {
    display: none;
    overflow: hidden;
    height: 0;
    opacity: 0;
    transition: height 50ms;
}
#btn {
    display: none;
    margin: 0 auto;
    padding: 8px;
    width: 400px;
    border-radius: 4px;
}
#clean {
    display: none;
    margin: 0 auto;
    padding: 8px;
    width: 200px;
    border-radius: 4px;
}
#btn.writing, #clean.writing {
    display: block;
}
#title {
    margin-top: 1em;
    margin-bottom: 0.25em;
    text-align: center;
    font-size: 48px;
    color: #333;
}
#title.writing {
    margin-top: 0;
    margin-bottom: 1em;
    animation: 10s pulse infinite alternate;
}
#ta {
    width: 400px;
    height: 400px;
    border: none;
    padding: 12px;
    font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
    font-weight: 400;
    font-size: 20px;
}
#ta:focus {
    border: none;
    box-shadow: 0;
    outline: none !important;
}

#footer {
    background: #ccc;
    padding: 24px;
    margin: 24px auto;
    width: 352px;
    text-align: center;
    font-size: 12px;
    font-family: medium-content-serif-font,Georgia,Cambria,"Times New Roman",Times,serif;
}
#footer a {
    color: white;
    font-weight: 300;
}
#footer:hover {
    background: #333;
}

@keyframes pulse {
    0% { opacity: 0; }
    50% { opacity: 0.8; }
    100% { opacity: 0; }
}

</style>

    <script>
        let title = document.getElementById('title')
        let instructions = document.getElementById('instructions')
        let btn = document.getElementById('btn')
        let clean = document.getElementById('clean')
        let ta = document.getElementById('ta')
        let started = false

        ta.focus()

        function withData(url_) {
            ta.focus()
            let o = {
                txt: ta.value,
                cursor: ta.selectionStart,
            }
            send2Server(url_, o, (err, upd) => {
                if(err) {
                    alert('Error!')
                    console.error(err)
                } else {
                    ta.value = upd.txt
                    ta.selectionStart = upd.cursor
                    ta.selectionEnd = upd.cursor
                    ta.blur()
                    ta.focus()
                }
            })
        }

        function monkey() {
            withData('/monkey')
        }

        function cleanMonkey() {
            withData('/clean')
        }

        function send2Server(url_, data, cb) {
            let xhr = new XMLHttpRequest()
            xhr.onreadystatechange = function() {
                if(xhr.readyState !== XMLHttpRequest.DONE) return
                if(xhr.status !== 200) cb(xhr)
                else {
                    try {
                        let r = JSON.parse(xhr.responseText)
                        cb(null, r)
                    } catch(e) {
                        cb(e)
                    }
                }
            }
            xhr.open('POST', url_)
            xhr.setRequestHeader("Content-Type", "application/json")
            xhr.send(JSON.stringify(data))
        }


        function startedWriting() {
            title.innerText = "Write"
            title.className = "writing"
            btn.className = "writing"
            clean.className = "writing"
            instructions.className = "writing"
        }

        ta.onpaste = () => {
            if(!started) startedWriting()
        }
        ta.onkeypress = (e) => {
            if(!started) startedWriting()
            if(e.keyCode == 13 && e.shiftKey) monkey()
        }

        btn.onclick = monkey
        clean.onclick = cleanMonkey

    </script>
</body>
</html>
